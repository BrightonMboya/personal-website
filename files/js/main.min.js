var workData;
var WORK_ACTIVE = false;

$(document).ready(function() {
	resetAll();
	loadPage();
});

async function loadPage() {

	workData = await loadWorkData();
	mobileSetup();
	await animatePageIn();
	navHandler();
	easeScroll();
	if (!isMobile()) {
		workListScroller();
		hoverTracker();
		//workCanvas();
	}
	workClickListener();
}





/****************************************
 * 
 * ASYNC DATA LOADERS AND ELEMENT STATE SETTERS
 * 
 ****************************************/

function loadWorkData() {
	return new Promise((resolve, error) => {
		fetch("files/js/data.json")
			.then((data) => data.json())
			.then((data) => {
				let workContainer = "#content-container .work-list ul";

				for (i=0; i<data.length; i++) {
					$(workContainer).append(
						`<li class="list-item w-animate clickable passive" data-id="${data[i].id}">
							<img draggable="false" data-lazysrc="files/imgs/work-back/${data[i].id}/cover.jpg" alt="${data[i].title} Background Image">
							<p class="item-date w-animate">${data[i].date}</p>
							<div class="text-wrapper">
								<p class="item-summary w-animate">${data[i].summary}</p>
								<h1 class="item-title w-animate">${data[i].title}</h1>
							</div>
						</li>`);
				}
				resolve(data);
		});
	});
}


function resetAll() {
	$('.fixed-scroll').css("position", "fixed");
	$("#content-container .parallax-wrapper.home-back").css("height", "0%");
	$("#content-container .title-wrapper *, .nav-wrapper").css("transform", "translateY(200%)");
	$("#content-container .parallax-wrapper.home-back img").css("transform", "scale(1.3)");
	$("#content-container .h-animate").css("transform", "translateY(100%)");
	$("#content-container .parallax-wrapper.home-back, #content-container .h-animate, #content-container .title-wrapper *, .nav-wrapper").css("opacity", "0");
	$("#content-container .load .loader").css("opacity", "0");
	$("#content-container .load .loader").css("transform", "translateY(50px)");
	$("#listing-container .details-wrapper *, #listing-container .primary-image-container").css("transform", "translateY(10vh)");
	$(".back-parallax-wrapper").css("opacity", "0");
	$("#listing-container .work-close-btn").css("display", "none");
	anime({
		targets: "#content-container .load .loader",
		opacity:1,
		translateY: "0",
		easing: "cubicBezier(0.23, 1, 0.32, 1)",
		duration: 1000,
		delay: 1000
	});
}


function animatePageIn() {
	return new Promise((resolve, error) => {

		let promiseArray = [];
		
		$('img[data-lazysrc]').each( function(i, e) {
			let promise = new Promise((resolve, error) => {
				this.src = $(this).data('lazysrc');
				this.onload = () => {
					resolve(i);
				}
			});
			promiseArray.push(promise);
		});

		Promise.all(promiseArray).then(() => {
			anime({
				targets: "#content-container .load .loader",
				opacity:0,
				translateY: "-50px",
				duration: 1000,
				delay: 1000,
				easing: "cubicBezier(0.755, 0.05, 0.855, 0.06)",
				complete: function() {
					$("#content-container .load").remove();

					anime({
						targets: ".nav-wrapper, .back-parallax-wrapper",
						translateY: "0%",
						opacity:1,
						easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
						duration: 1500,
						delay: 150
					});
					anime({
						targets: "#content-container .parallax-wrapper.home-back",
						height: "100%",
						opacity:1,
						easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
						duration: 1300,
						delay: 300
					});

					anime({
						targets: "#content-container .parallax-wrapper.home-back img",
						scale: "1",
						opacity:1,
						easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
						duration: 1400,
						delay: 200
					});
					setTimeout(function() {
						anime({
							targets: "#content-container .h-animate",
							translateY: "0%",
							opacity:1,
							easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
							duration: 1200,
							delay: anime.stagger(300),
							complete: function() {
								resolve();
							}
						});
					}, 400);
				}
			});
		});
	});
}






/****************************************
 * 
 * MOBILE SUPPORT
 * 
 ****************************************/


function isMobile() {
	return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function mobileSetup() {
	if (isMobile()) {
		$(".wave-filter, #content-container.work-click-area ul").each(function() {
			$(this).addClass("disabled");
		});
		$("#content-container .text-content .scroll-msg.subheader").text("Swipe Up");
		$("#work-canvas").remove();
		$("#content-container.work-click-area").css("overflow-x", "auto");
	}
}





/****************************************
 * 
 * NAVIGATION BUTTON AND SCROLL HANDLER 
 * 
 ****************************************/


function navHandler() {
	var locations = [
		{ 
			name: 'home',
			location: 0
		},
		{
			name: 'work',
			location: $("#content-container.work-click-area").offset().top
		},
		{	name: 'about',
			location: $("#content-container.about").offset().top
		}
	];
	$("body").data("position", locations[0].name);

	$(window).resize(() => {
		locations[1].location = $("#content-container.work-click-area").offset().top;
		locations[2].location = $("#content-container.about").offset().top;
	});

	let timeout;

	$('li.scroller span, .logo-icon').click((e) => {
		mobileNav(true);
		let parent = $(e.target).parent(".scroller").length;
		let dataName = parent ? $(e.target).parent().data("name") : $(e.target).data("name");
		let locationObj = locations.find(e => e['name'] === dataName);
		$("body").data("position", locationObj.name);
		window.scroll({
			top: locationObj.location,
			behavior: 'smooth'
		});
	});

	$('.m-nav-wrapper li span').on('hover', function() {
		$(".m-nav-wrapper .background").addClass("transition");
		setTimeout(() => {
			let image = document.querySelector(".m-nav-wrapper .background");
			image.src = `files/imgs/back/nav-back-${$(this).parent().index()+1}.png`;
			image.onload = () => {
				$(".m-nav-wrapper .background").removeClass("transition");
			};
		}, 400);
	});

	document.addEventListener('wheel', (e) => {
		if (!WORK_ACTIVE) {
			e.preventDefault();
			if (!timeout) {
				let isDown = (e.deltaY < 0) ? true : false;
				scrollPage(isDown);

				timeout = setTimeout(() => {
					timeout = undefined;
				}, 1000)
			}
		}
	}, { passive: false });

	function scrollPage(isDown) {
		let dataName = $("body").data("position");
		let index = locations.findIndex(e => e['name'] === dataName);
		let newPosition;

		if (!isDown) {
			newPosition = ((index+1) == locations.length) ? false : locations[index+1];
		} else {
			newPosition = (index == 0) ? false : locations[index-1];
		}

		if (newPosition) $("body").data("position", newPosition.name);
		
		locations[1].location = $("#content-container.work-click-area").offset().top;
		locations[2].location = $("#content-container.about").offset().top;

		window.scroll({
			top: newPosition.location,
			behavior: 'smooth'
		});
	}

	// Mobile navigation handler

	$(".m-nav-wrapper ul li").css("opacity", "0");
	$(".m-nav-wrapper ul li").css("transform", "translateY(5vh)");

	$(".nav-wrapper .hb-button").click(function() {
		active = $(this).hasClass("close");
		mobileNav(active);
	});

	function mobileNav(close) {
		if (close) {
			anime({
				targets: ".m-nav-wrapper img.background",
				opacity: 0,
				easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
				duration: 700,
				complete: () => {
					anime({
						targets: ".m-nav-wrapper ul li",
						opacity: 0,
						easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
						duration: 800,
						complete: () => {
							$(".m-nav-wrapper ul li").css("transform", "translateY(5vh)")
						}
					});
					$(".nav-wrapper .hb-button").removeClass("close");
					$(".nav-wrapper .logo-icon").removeClass("invert");
					$(".m-nav-wrapper").removeClass("active");
				}
			});
		} else {
			$(".nav-wrapper .hb-button").addClass("close");
			$(".nav-wrapper .logo-icon").addClass("invert");
			$(".m-nav-wrapper").addClass("active");
			anime({
				targets: ".m-nav-wrapper ul li, .m-nav-wrapper img.background",
				opacity: 1,
				translateY: "0vh",
				easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
				duration: 1000,
				delay: anime.stagger(150, {start: 500})
			});
		}
	}
                                                  
	let yDown = null; let xDown = null; let checkHorizontal;                                                        

	document.addEventListener('touchstart', (e) => {
		yDown = e.touches[0].clientY;
		xDown = e.touches[0].clientX;
	}, false);

	document.addEventListener('touchmove', (e) => {
		if (!WORK_ACTIVE) {
			checkHorizontal = ($(e.target).parents(".work-list").length);
			if (!checkHorizontal) e.preventDefault();
			
			if (e.cancelable && !checkHorizontal) e.preventDefault();

			if (!yDown || !xDown) return;

			let yUp = e.touches[0].clientY;
			let xUp = e.touches[0].clientX;
			let yDiff = yDown - yUp;
			let xDiff = xDown - xUp;
			
			if ( Math.abs( xDiff ) <= Math.abs( yDiff ) ) {
				e.preventDefault();
				isDown = (yDiff > 0) ? false : true;
				scrollPage(isDown);
			} else {
				e.returnValue = true;
			}

			xDown = null;
			yDown = null;
		}
	}, { passive: false, cancelable: true });
}





/****************************************
 * 
 * SLIDESHOW HANDLER 
 * WORK LIST SLIDESHOW CLICK & DRAG HANDLER
 * 
 ****************************************/

function workListScroller() {

	let isClick, endPosition, initialMousePosX, initialPos;
	let slider = $('#content-container .work-list');
	let maxSpeed = 5000;

	slider.css("transform", "translateX(0px)");
	calculateEndPos();

	$(document).mousedown((e) => {
		if (!isWork() || WORK_ACTIVE) return;
		initialMousePosX = e.clientX;
		isClick = true;
		setTimeout(() => {
			if (isClick) {
				slider.addClass("hold");
				$(".hover-container").addClass("scroll");
				initialPos = slider.css("transform").match(/-?[\d\.]+/g);
				initialPos = parseInt(initialPos[4]);
			}
		}, 150);
	});

	$(document).mouseleave(() => {
		isClick = false;
		$(".hover-container").removeClass("scroll");
		slider.removeClass("hold");
	});

	$(document).mouseup(() => {
		isClick = false;
		setTimeout(() => {
			$(".hover-container").removeClass("scroll");
			slider.removeClass("hold");
		}, 10);
	});

	$(document).mousemove((e) => {
		if (!isClick || !isWork() || WORK_ACTIVE) return;
		e.preventDefault();
		
		secondPosX = e.clientX;
		diff = secondPosX - initialMousePosX;
		calcPosition = initialPos - (maxSpeed * (diff / document.body.clientWidth));
		
		if (calcPosition > 0) calcPosition = 0;
		if (calcPosition <= (endPosition * -1)) calcPosition = endPosition*-1;
		
		slider.css("transform", `translateX(${calcPosition}px)`);
	});

	function isWork() {
		return ($("body").data("position") == "work");
	}

	$(window).resize(() => {
		calculateEndPos();
	});

	function calculateEndPos() {
		let perView, perEntireView;
		let listItems = slider.children("ul").children("li");
		let sliderWidth = 0;

		$("#content-container .work-list ul li").each(function() {
			sliderWidth += $(this).outerWidth();
			perView = Math.floor(slider.outerWidth()/$(this).outerWidth());
		});

		perEntireView = sliderWidth / listItems.length;
		endPosition = perEntireView * (listItems.length - perView);
	}
}






/****************************************
 * 
 * WORK CANVAS 
 * CANVAS MOUSE TRACKING, HOVERING, AND CLICKING
 * 
 ****************************************/

function hoverTracker() {
	let hoverContainer = ".hover-container";
	let x = 0;
	let y = 0;

	$(document).mousemove(trackMouse);
	$(document).mouseup((e) => {setTimeout(() => {trackMouse(e)}, 50);});

	function trackMouse(e) {
		let t = 0;
		let active;

		if ($(".work-list").hasClass("hold")) return;

		clickableElement = isHoveringClickable(e);
		if (clickableElement) {
			$(hoverContainer).addClass("hover");
			$("body").css("cursor", "pointer");
			if (!$(clickableElement).hasClass("hover")) {
				$(clickableElement).addClass("hover").trigger("hover");
			}
			$(".hover:not(.hover-container)").each(function() {
				if (this != clickableElement) {
					$(this).removeClass("hover");
				}
			});
		} else {
			$("body").css("cursor", "default");
			$(".hover").each(function() {
				$(this).removeClass("hover");
			});
		}

		if ($(clickableElement).hasClass("passive") || !clickableElement) {
			active = {
				x: e.clientX,
				y: e.clientY
			}
		} else {
			active = {
				x: (clickableElement.getBoundingClientRect().left + ($(clickableElement).width() / 2)),
				y: (clickableElement.getBoundingClientRect().top + ($(clickableElement).height() / 2))
			},
			active = {
				x: active.x + ((active.x - e.clientX)*0.1),
				y: active.y + ((active.y - e.clientY)*0.1)
			}
		}

		function loop() {
			x += (easeInOutQuad(t) * ((active.x - x) - ($(hoverContainer).width() / 2)));
			y += (easeInOutQuad(t) * ((active.y - y) - ($(hoverContainer).height() / 2)));

			$(hoverContainer).css("left", x + "px");
			$(hoverContainer).css("top", y + "px");
			
			if (t < 1) {
				t += 0.04;
				requestAnimationFrame(loop);
			}
		}
		loop();

		if (!$(hoverContainer).hasClass("active")) {
			setTimeout(() => {
				$(hoverContainer).addClass("active");
			}, 100);
		}
	}

	$(hoverContainer).click((e) => {
		clickableElement = isHoveringClickable(e);
		if (clickableElement) $(clickableElement).click();
	});

	function isHoveringClickable(e) {
		let isHover, hoverElem;
		
		$(".clickable").each(function (i) {
			let elemTop = $(this).offset().top;
			let elemBottom = elemTop + $(this).outerHeight();
			let elemLeft = $(this).offset().left;
			let elemRight = elemLeft + $(this).outerWidth();

			if (!isHover) {
				isHover = (((e.pageY <= elemBottom) && (e.pageY >= elemTop)) && ((e.pageX >= elemLeft) && (e.pageX <= elemRight)));
				hoverElem = this;
				if (hoverElem) {
					let x = hoverElem.getBoundingClientRect().left;
					let y = hoverElem.getBoundingClientRect().top;
					let topElt = document.elementFromPoint(x,y);
					if (topElt) {
						let overlay = hoverElem.contains(topElt) || topElt.isSameNode(document.querySelector(hoverContainer));
						
						if (!overlay) isHover = false;
					}

					
				}
			}
		});

		if (isHover) return hoverElem;
		return false;
	}

	function easeInOutQuad(t) {
		return t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
	}
}




/****************************************
 * 
 * Work Click Listeners & Handlers 
 * REDUNDANT CODE, NEEDS TO BE REAUDITED
 * 
 ****************************************/

function openItem(id) {
	$("#listing-container .f-date, #listing-container .f-title, #listing-container .f-description, #listing-container .links, #listing-container .f-index span, #listing-container .f-subtitle, #listing-container .f-s-description, #listing-container .roles").html("")
	$("#listing-container").scrollTop(0);

	$("#listing-container .f-date").text(workData[id].date);
	$("#listing-container .f-title").text(workData[id].title);
	$("#listing-container .f-description").text(workData[id].details.description);
	$("#listing-container .f-index span").text("0" + workData[id].id);
	$("#listing-container .f-subtitle").text(workData[id].details.subtitle);
	$("#listing-container .f-s-description").text(workData[id].details.description2);
	document.querySelector("#listing-container .primary-image-container").src = 'files/imgs/work-back/'+workData[id].id+'/primary.png';
	document.querySelector("#listing-container .secondary-image-wrapper img").src = 'files/imgs/work-back/'+workData[id].id+'/secondary.png';

	for (i=0; i<workData[id].roles.length; i++) {
		$("#listing-container .roles").append(`<li>${workData[id].roles[i]}</li>`);
	}
	for (i=0; i<workData[id].links.length; i++) {
		$("#listing-container .links").append(`<a class="w-link clickable f-link" onclick="window.open('${workData[id].links[i].link}', '_blank')">${workData[id].links[i].text}</li>`);
	}

	WORK_ACTIVE = true;
	$(".nav-wrapper .hb-button, .nav-wrapper .logo-icon").addClass("invert");
	$("#listing-container .details-wrapper *, #listing-container .primary-image-container, #listing-container .stats-wrapper *, #listing-container .secondary-image-wrapper").css("transform", "translateY(10vh)");
	$("#listing-container .details-wrapper *, #listing-container .primary-image-container, #listing-container .stats-wrapper *, #listing-container .secondary-image-wrapper").css("opacity", "0");
	anime({
		targets: ".fixed-scroll",
		marginLeft: "10%",
		easing: "cubicBezier(0.86, 0, 0.07, 1)",
		duration: 1200
	});
	anime({
		targets: "#listing-container .content-wrapper",
		paddingLeft: "7vw",
		easing: "cubicBezier(0.23, 1, 0.32, 1)",
		duration: 1450
	});
	anime({
		targets: "#listing-container",
		width: "100vw",
		easing: "cubicBezier(0.86, 0, 0.07, 1)",
		duration: 1200,
		complete: () => {
			anime({
				targets: "#listing-container .primary-image-container, #listing-container .secondary-image-wrapper",
				opacity: "1",
				translateY: "0vh",
				easing: "cubicBezier(0.25, 1, 0.5, 1)",
				duration: 1500,
				delay: 700
			});
			anime({
				targets: "#listing-container .details-wrapper *, #listing-container .stats-wrapper *",
				opacity: "1",
				translateY: "0vh",
				easing: "cubicBezier(0.25, 1, 0.5, 1)",
				duration: 1500,
				delay: anime.stagger(200),
				complete: () => {
					$("#listing-container .work-close-btn").css("display", "block");
					setTimeout(() => {
						$("#listing-container .work-close-btn").addClass("show");
					}, 100);
				}
			});			
		}
	});
}

function workClickListener() {

	$(".work-close-btn, .scroller, .logo-icon").click(function(e) {
		closeItem()
	});

	$(".list-item").click(function(e) {
		openItem(parseInt($(this).data('id'))-1);
	});

	function closeItem() {
		WORK_ACTIVE = false;
		$("#listing-container .work-close-btn").removeClass("show");
		anime({
			targets: "#listing-container .primary-image-container, #listing-container .secondary-image-wrapper",
			opacity: "0",
			easing: "cubicBezier(0.25, 1, 0.5, 1)",
			duration: 400
		});
		anime({
			targets: "#listing-container .details-wrapper *, #listing-container .stats-wrapper *",
			opacity: "0",
			easing: "cubicBezier(0.25, 1, 0.5, 1)",
			duration: 400,
			complete: () => {
				$("#listing-container .details-wrapper *, #listing-container .primary-image-container, #listing-container .stats-wrapper *, #listing-container .secondary-image-wrapper").css("transform", "translateY(10vh)");
				$("#listing-container .details-wrapper *, #listing-container .primary-image-container, #listing-container .stats-wrapper *, #listing-container .secondary-image-wrapper").css("opacity", "0");
				setTimeout(() => {
					$(".nav-wrapper .hb-button, .nav-wrapper .logo-icon").removeClass("invert");
				}, 400)
				anime({
					targets: ".fixed-scroll",
					marginLeft: "0",
					easing: "cubicBezier(0.86, 0, 0.07, 1)",
					duration: 1300
				});
				anime({
					targets: "#listing-container .content-wrapper",
					paddingLeft: "0",
					easing: "cubicBezier(0.86, 0, 0.07, 1)",
					duration: 1300
				});
				anime({
					targets: "#listing-container",
					width: "0vw",
					easing: "cubicBezier(0.86, 0, 0.07, 1)",
					duration: 1200,
					complete: () => {
						$("#listing-container .work-close-btn").css("display", "none");
					}
				});
			}
		});	
	}
}





/****************************************
 * 
 * Scroll animation handlers
 * 
 ****************************************/

function easeScroll() {
	animateOnScroll();

	m.transitions.mntm_scroll(".fixed-scroll", [
		{element: ".parallax-wrapper, .list-item", offsetY: 6},
		{element: ".fixed-scroll", offsetY: -1},
		{element: ".back-parallax-wrapper", offsetY: 4},
	], 1000, "cubic-bezier(0.19, 1, 0.22, 1)");

	$("body").css("overflow-y", "hidden");
}

function animateOnScroll() {

	var animated = [];

	$(".list-item, .list-item .w-animate, .a-animate").css("opacity", "0");
	$(".list-item, .list-item .w-animate, .a-animate").css("transform", "translateY(50%)");

	function inView(elem) {
	  var docViewTop = $(window).scrollTop();
	  var docViewBottom = docViewTop + $(window).height();

	  var elemTop = $(elem).offset().top;
	  var elemBottom = elemTop + ($(elem).height()/2);

	  return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
	}

	function animate(el, i) {
		if (!animated.includes(el)) {
			animated.push(el);
			anime({
				targets: el,
				opacity:1,
				translateY: "0",
				easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
				duration: 1000,
				complete: function() {
					$(el).addClass("scroll-done");
				},
				delay: anime.stagger(200, {start: i*200})
			});
		}
	}

	$(window).scroll(function() {
		if (inView("#content-container.work-click-area")) {
			setTimeout(() => {
				$('.list-item').each(function (index) {
					anime({
						targets: ".list-item",
						opacity:1,
						translateY: "0",
						easing: "cubicBezier(0.165, 0.84, 0.44, 1)",
						duration: 1000,
						delay: anime.stagger(150, {start: i*50})
					});

					setTimeout(() => {
						animate(".list-item:nth-child("+(index+1)+") .item-title.w-animate", index);
					}, 500);
					setTimeout(() => {
						animate(".list-item:nth-child("+(index+1)+") .item-summary.w-animate", index);
					}, 600);
					setTimeout(() => {
						animate(".list-item:nth-child("+(index+1)+") .item-date.w-animate", index);
					}, 700);
				});
			}, 300);
		}
		 
		if ($("body").data("position") == "about") {
			setTimeout(() => {
				animate("#content-container.about .a-animate", 1);
				$("#content-container.about .background").css("opacity", "1");
			}, 300);
		}
	});
}
